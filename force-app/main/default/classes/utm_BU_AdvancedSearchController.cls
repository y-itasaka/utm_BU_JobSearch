public with sharing class utm_BU_AdvancedSearchController {

    @AuraEnabled(cacheable=true)
    public static List<JobOffer_BU__c> utm_BU_searchJobs(
        String keyword,
        List<String> jobTypes,
        List<String> holidays,
        List<String> workStyles,
        List<String> employmentTypes,
        Decimal minWage,
        Decimal maxWage,
        String startTimeStr,
        String endTimeStr,
        Boolean experienceApplication  // ğŸ”¥ ä½“é¨“å¿œå‹Ÿãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è¿½åŠ 
    ) {
        String query = 'SELECT Id, Name, PRPR_point3__c, CompanyInformation__c, Characteristics__c, Welfare__c, ' +
                       'WorkLocation__c, EmploymentStatus__c, Salary__c, QualificationRequirements__c, Destination__c, ' +
                       'RecruitmentReception__c, Number__c, EyeCatchImage__c, eyecatch_url__c, ' +
                       'joboffer__r.Field1702__c, joboffer__r.Field1624__c, joboffer__r.BusinessContent__c, ' +
                       'joboffer__r.BusinessContent_sub__c, joboffer__r.Field1619__c, joboffer__r.Field1734__c, ' +
                       'joboffer__r.Field1660__c, joboffer__r.Field1663__c, joboffer__r.Field1908__c, ' +
                       'joboffer__r.Salary01__c, joboffer__r.Field1591__c, joboffer__r.Field1585__c, joboffer__r.Field1608__c, ' +
                       'joboffer__r.SeishainTouyou_Base__c, joboffer__r.Field1864__c ' +  // ğŸ”¥ ä½“é¨“å¿œå‹Ÿãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰è¿½åŠ 
                       'FROM JobOffer_BU__c ';

        List<String> conditions = new List<String>();

        if (String.isNotBlank(keyword)) {
            // æ­£è¦åŒ–ï¼šå…¨è§’ã‚¹ãƒšãƒ¼ã‚¹ãƒ»å…¨è§’orãƒ»å¥èª­ç‚¹ã‚’åŠè§’ã«å¤‰æ›
            String normalized = keyword
                .replaceAll('ã€€', ' ')
                .replaceAll('[ï½ï½’ï¼¯ï¼²]', 'or')
                .replaceAll('[ã€ã€‚ï¼ï¼Œï½¡ï½¤]', ' ')
                .toLowerCase()
                .trim();
        
            List<String> tokens = normalized.split('\\s+');
            List<String> andConditions = new List<String>();
            List<String> orGroup = new List<String>();
        
            for (Integer i = 0; i < tokens.size(); i++) {
                String token = tokens[i].trim();
        
                if (token == 'or') {
                    continue; // ã‚¹ã‚­ãƒƒãƒ—
                }
        
                // å‰å¾Œã« "or" ãŒã‚ã‚‹ â†’ ORã‚°ãƒ«ãƒ¼ãƒ—è¦ç´ ã¨ã¿ãªã™
                Boolean prevIsOr = (i > 0 && tokens[i - 1] == 'or');
                Boolean nextIsOr = (i < tokens.size() - 1 && tokens[i + 1] == 'or');
        
                if (prevIsOr || nextIsOr) {
                    orGroup.add(token);
                } else {
                    if (!orGroup.isEmpty()) {
                        andConditions.add('(' + buildOrCondition(orGroup) + ')');
                        orGroup.clear();
                    }
                    andConditions.add('(' + buildOrCondition(new List<String>{token}) + ')');
                }
            }
        
            // æ®‹ã£ãŸORã‚°ãƒ«ãƒ¼ãƒ—ã‚’è¿½åŠ 
            if (!orGroup.isEmpty()) {
                andConditions.add('(' + buildOrCondition(orGroup) + ')');
            }
        
            if (!andConditions.isEmpty()) {
                conditions.add(String.join(andConditions, ' AND '));
            }
        }

        // 3. ä¼‘æ—¥
        if (holidays != null && !holidays.isEmpty()) {
            List<String> holidayConds = new List<String>();
            for (String h : holidays) {
                if (h == 'åœŸ') {
                    holidayConds.add('joboffer__r.Field1908__c INCLUDES (\'åœŸ\', \'åœŸï¼ˆéš”é€±ï¼‰\')');
                } else {
                    holidayConds.add('joboffer__r.Field1908__c INCLUDES (\'' + String.escapeSingleQuotes(h) + '\')');
                }
            }
            conditions.add(String.join(holidayConds, ' AND '));
        }

        // 4. åƒãæ–¹
        if (workStyles != null && !workStyles.isEmpty()) {
            for (String s : workStyles) {
                if (s == 'æ­£ç¤¾å“¡') conditions.add('joboffer__r.Field1688__c = true');
                if (s == 'è»½ä½œæ¥­') conditions.add('joboffer__r.Field1685__c = true');
                if (s == 'æœªçµŒé¨“OK') conditions.add('joboffer__r.OK__c = true');
                if (s == 'æ‰¶é¤Šå†…') conditions.add('joboffer__r.Field1623__c = true');
                if (s == 'ã‚·ãƒ‹ã‚¢') conditions.add('joboffer__r.Field1687__c = true');
            }
        }

        // 5. æ™‚çµ¦
        if (minWage != null) {
            conditions.add('joboffer__r.Field1619__c >= :minWage');
        }
        if (maxWage != null) {
            conditions.add('joboffer__r.Field1619__c <= :maxWage');
        }

        // ğŸ”¥ 6. ä½“é¨“å¿œå‹Ÿãƒ•ã‚£ãƒ«ã‚¿è¿½åŠ 
        if (experienceApplication != null && experienceApplication == true) {
            conditions.add('joboffer__r.Field1864__c = \'ä½“é¨“å¿œå‹Ÿ\'');
        }

        // 7. WHEREå¥ã‚’ã¾ã¨ã‚ã¦è¿½åŠ 
        if (!conditions.isEmpty()) {
            query += ' WHERE ' + String.join(conditions, ' AND ');
        }

        // 8. LIMIT
        query += ' LIMIT 200';

        // 9. å®Ÿè¡Œ
        List<JobOffer_BU__c> offers = Database.query(query);

        // 10. å‹¤å‹™æ™‚é–“ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
        if (String.isNotBlank(startTimeStr) || String.isNotBlank(endTimeStr)) {
            Time startTime = null;
            Time endTime = null;

            if (String.isNotBlank(startTimeStr)) {
                List<String> parts = startTimeStr.split(':');
                startTime = Time.newInstance(Integer.valueOf(parts[0]), Integer.valueOf(parts[1]), 0, 0);
            }
            if (String.isNotBlank(endTimeStr)) {
                List<String> parts = endTimeStr.split(':');
                endTime = Time.newInstance(Integer.valueOf(parts[0]), Integer.valueOf(parts[1]), 0, 0);
            }

            List<JobOffer_BU__c> filtered = new List<JobOffer_BU__c>();
            for (JobOffer_BU__c o : offers) {
                Time jobStart = o.joboffer__r.Field1660__c;
                Time jobEnd = o.joboffer__r.Field1663__c;

                if (jobStart == null || jobEnd == null) continue;

                Boolean isNightShift = jobEnd < jobStart;
                Boolean keep = true;

                if (startTime != null && endTime != null) {
                    if (endTime > startTime) {
                        if (isNightShift) {
                            keep = false;
                        } else {
                            keep = (jobStart >= startTime && jobEnd <= endTime);
                        }
                    } else {
                        keep = (jobStart >= startTime || jobStart <= endTime) &&
                               (jobEnd >= startTime || jobEnd <= endTime);
                    }
                } else if (startTime != null) {
                    keep = jobStart >= startTime;
                } else if (endTime != null) {
                    keep = jobEnd <= endTime;
                }

                if (keep) {
                    filtered.add(o);
                }
            }

            offers = filtered;
        }

        return offers;
    }

    // ğŸ”§ ORæ¡ä»¶ã®éƒ¨åˆ†ä¸€è‡´ã‚¯ã‚¨ãƒªã‚’æ§‹ç¯‰ã™ã‚‹è£œåŠ©é–¢æ•°
    public static String buildOrCondition(List<String> words) {
        List<String> orConditions = new List<String>();
        for (String word : words) {
            String escaped = String.escapeSingleQuotes(word);
            List<String> sub = new List<String>();
            
            // JobOffer_BU__cã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
            for (String f : new List<String>{
                'Name', 'PRPR_point3__c', 'CompanyInformation__c', 'Characteristics__c',
                'Welfare__c', 'WorkLocation__c', 'EmploymentStatus__c',
                'Salary__c', 'QualificationRequirements__c', 'Destination__c',
                'RecruitmentReception__c', 'Number__c'
            }) {
                sub.add(f + ' LIKE \'%' + escaped + '%\'');
            }
            
            // joboffer__rã®é–¢é€£ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
            for (String f : new List<String>{
                'joboffer__r.BusinessContent__c',
                'joboffer__r.BusinessContent_sub__c'
            }) {
                sub.add(f + ' LIKE \'%' + escaped + '%\'');
            }
            
            orConditions.add('(' + String.join(sub, ' OR ') + ')');
        }
        return String.join(orConditions, ' OR ');
    }
}